---
title: "MPH Thesis: Lindsey Abramson"
output: github_document
date: "2025-10-01"
---

Main research question?


Go in and separate by each year and county. 
Overlapping 45 parks between the two years.
Ask maria about including infection prevalence.
Just focus on nymphas ticks or include all?
Jesse's thesis?
Visual map to show the different transect types.
Marie has the layers for mappings.


```{r setup, echo = FALSE, message = FALSE}
library(geosphere)
library(knitr)
library(tidyverse)
library(dplyr)
library(readxl)
library(haven)
library(leaflet)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Import and Tidy Data

Import dataset
```{r}
ticknyc_df=
read_csv("data/Tick_nyc_clean_23_24.csv") |>
  janitor::clean_names() |>
    mutate(date = mdy(date))
```

Standardize by transect for 100m. Create a new column, by 100m.
By park and transect type.
```{r}
# Fix the GPS parsing - handle the different formats in your data
ticknyc_df$fraction_of_100m <- apply(ticknyc_df, 1, function(row) {
  tryCatch({
    # Extract coordinates
    start_lon <- as.numeric(row['longitude_start'])
    start_lat <- as.numeric(row['latitude_start'])
    
    # Clean and parse end coordinates from gps_end
    gps_end <- row['gps_end']
    
    # Remove any spaces and split by comma
    coords_clean <- gsub("\\s", "", gps_end)  # Remove all spaces
    coords_split <- strsplit(coords_clean, ",")[[1]]
    
    end_lat <- as.numeric(coords_split[1])
    end_lon <- as.numeric(coords_split[2])
    
    # Calculate distance in meters
    distance_m <- distGeo(c(start_lon, start_lat), c(end_lon, end_lat))
    
    # Return fraction of 100m
    round(distance_m / 100, 4)
    
  }, error = function(e) {
    return(NA)
  })
})

# Create standardized 100m transect ID
ticknyc_df$transect_100m_standard <- paste0(ticknyc_df$transect_no, "_", round(ticknyc_df$fraction_of_100m, 2))

# Check if it worked
head(ticknyc_df[, c('transect_no', 'longitude_start', 'latitude_start', 'gps_end', 'fraction_of_100m', 'transect_100m_standard')])

# See how many succeeded
sum(!is.na(ticknyc_df$fraction_of_100m))

```


Correct for date (phenology). Describe the phenology. *Discuss at the group meeting.Can put the date as a random effect 
```{r}

```

Correct for weather?
```{r}

```

## Main Descriptive Summaries

```{r}
ticknyc_df |>
  group_by(transect_type) |>
  summarise(
    amblyomma_nymph_count = sum(amblyomma_americanum_nymph),
    ixodes_nymph_count = sum(ixodes_scapularis_nymph)
  ) |>
   knitr::kable()

ticknyc_df |>
  group_by(transect_type) |>
  summarise(
    mean_amblyomma_nymph = mean(amblyomma_americanum_nymph, na.rm = TRUE),
    mean_ixodes_nymph = mean(ixodes_scapularis_nymph, na.rm = TRUE),
    n_transects = n()
  )  |>
   knitr::kable()
```


## Extra Descriptive Summaries
Overview
```{r}
ticknyc_df |>
  summarise(
      Total_Transects = n(),
    Total_Ticks = sum(total, na.rm = TRUE),
    Mean_Ticks_Per_Transect = round(mean(total, na.rm = TRUE), 2),
    Max_Ticks_Single_Transect = max(total, na.rm = TRUE)
  ) |>
   knitr::kable()
```



County summary
```{r}
ticknyc_df |>
  group_by(county) |>
  summarise(
    Transects = n(),
    Total_Ticks = sum(total, na.rm = TRUE),
    Mean_ticks_per_transect = mean(total, na.rm = TRUE),
    Median_ticks_per_transect = median(total, na.rm = TRUE),
    Percent_transects_with_ticks = round(mean(total > 0, na.rm = TRUE) * 100, 1),
  ) |>
  arrange(desc(Total_Ticks)) |>
   knitr::kable()
```



Transect type summary
```{r}
ticknyc_df |>
  group_by(transect_type) |>
  summarise(
   Transects = n(),
    Total_Ticks = sum(total, na.rm = TRUE),
    Mean_ticks_per_transect = mean(total, na.rm = TRUE),
    Median_ticks_per_transect = median(total, na.rm = TRUE),
    Percent_transects_with_ticks = round(mean(total > 0, na.rm = TRUE) * 100, 1)) |> 
  arrange(desc(Total_Ticks)) |>
   knitr::kable()
```



Species counts
```{r}
ticknyc_df |>
  summarise(
    ixodes_total = sum(across(starts_with("ixodes")), na.rm = TRUE),
    amblyomma_total = sum(across(starts_with("amblyomma")), na.rm = TRUE),
    dermacentor_total = sum(across(starts_with("dermacentor")), na.rm = TRUE),
    haemaphysalis_total = sum(across(starts_with("haemaphysalis")), na.rm = TRUE),
    rhipicephalus_total = sum(across(starts_with("rhipicephalus")), na.rm = TRUE),
    unknown_total = sum(across(starts_with("unknown")), na.rm = TRUE)
) |>
   knitr::kable()
```



Species + life stage count
```{r}
ticknyc_df |>
  summarise(across(amblyomma_americanum_adult:unknown_unknown, ~sum(., na.rm = TRUE))) |>
  pivot_longer(everything(), names_to = "Species_LifeStage", values_to = "Count") |>
  arrange(desc(Count)) |>
  print() |>
   knitr::kable()
```



Species by transect type
```{r}
ticknyc_df |>
  group_by(transect_type) |>
  summarise(
      ixodes_total = sum(across(starts_with("ixodes")), na.rm = TRUE),
    amblyomma_total = sum(across(starts_with("amblyomma")), na.rm = TRUE),
    dermacentor_total = sum(across(starts_with("dermacentor")), na.rm = TRUE),
    haemaphysalis_total = sum(across(starts_with("haemaphysalis")), na.rm = TRUE),
    rhipicephalus_total = sum(across(starts_with("rhipicephalus")), na.rm = TRUE),
    unknown_total = sum(across(starts_with("unknown")), na.rm = TRUE)
  ) |>
  pivot_longer(-transect_type, names_to = "species", values_to = "count") %>%
  pivot_wider(names_from = transect_type, values_from = count, values_fill = 0) |>
   knitr::kable()
```



Species count in each county
```{r}
ticknyc_df |>
  group_by(county) |>
  summarise(
    ixodes_total = sum(across(starts_with("ixodes")), na.rm = TRUE),
    amblyomma_total = sum(across(starts_with("amblyomma")), na.rm = TRUE),
    dermacentor_total = sum(across(starts_with("dermacentor")), na.rm = TRUE),
    haemaphysalis_total = sum(across(starts_with("haemaphysalis")), na.rm = TRUE),
    rhipicephalus_total = sum(across(starts_with("rhipicephalus")), na.rm = TRUE),
    unknown_total = sum(across(starts_with("unknown")), na.rm = TRUE)
  ) |>
  pivot_longer(-county, names_to = "species", values_to = "count") |>
  pivot_wider(names_from = county, values_from = count, values_fill = 0) |>
    knitr::kable()
```

Life stages count
```{r}
ticknyc_df |>
  summarise(
    Adults = sum(across(ends_with("_adult")), na.rm = TRUE),
    Nymphs = sum(across(ends_with("_nymph")), na.rm = TRUE),
    Larvae = sum(across(ends_with("_larva")), na.rm = TRUE),
    Total = Adults + Nymphs + Larvae
  ) |>
    knitr::kable()
```

Life staage count by county
```{r}
ticknyc_df |>
  group_by(county) |>
  summarise(
    Adults = sum(across(ends_with("_adult")), na.rm = TRUE),
    Nymphs = sum(across(ends_with("_nymph")), na.rm = TRUE),
    Larvae = sum(across(ends_with("_larva")), na.rm = TRUE),
    Total = Adults + Nymphs + Larvae
  ) |>
  knitr::kable()
```

Life stage count by transect type
```{r}
ticknyc_df |>
  group_by(transect_type) |>
  summarise(
    Adults = sum(across(ends_with("_adult")), na.rm = TRUE),
    Nymphs = sum(across(ends_with("_nymph")), na.rm = TRUE),
    Larvae = sum(across(ends_with("_larva")), na.rm = TRUE),
    Total = Adults + Nymphs + Larvae
  ) |>
  knitr::kable()
```


