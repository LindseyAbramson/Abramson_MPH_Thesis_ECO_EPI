---
title: "Creating 2025 data"
output: html_document
date: "2025-12-17"
---

```{r setup, include=FALSE}
library(geosphere)
library(knitr)
library(tidyverse)
library(dplyr)
library(readxl)
library(haven)
library(leaflet)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

  
```{r}
#read in data
field_data <- read_csv("data/FIELD DATA.csv") |>
  janitor::clean_names() 
tick_id <- read_csv("data/TICK ID.csv") |>
    janitor::clean_names()

field_data <- field_data %>%
  group_by(site) %>%
  mutate(
    drag_round = if_else(date == min(date, na.rm = TRUE), 1, 2)
  ) %>%
  ungroup()

# 2. Count ticks by transect (super simple)
tick_counts <- tick_id %>%
  count(`transect_no`, species, stage, sex_if_adult) %>%
  pivot_wider(
    names_from = c(species, stage),
    values_from = n,
    values_fill = 0
  )

# 3. Get ALL field data - one row per transect with everything
field_summary <- field_data %>%
  group_by(transect_no) %>%
  summarise(
    drag_round = first(drag_round),
    Site = first(site),
    Transect.type = first(transect_type),
    Date = first(date),
    Temperature = first(temperature),
    Humidity = first(relative_humidity),
    GPS.Start = first(gps_start),
    GPS.End = first(gps_end),
    Start.Time = first(start_time),
    End.Time = first(end_time),
   Collector = first(collector),
     Notes = paste(unique(na.omit(notes)), collapse = "; "),
    Habitat.list = paste(habitat_type[order(section)], collapse = ", "),
    .groups = "drop"
  )

# 4. Combine them
new_data <- field_summary %>%
  left_join(tick_counts, by = c("transect_no")) |>
  mutate(
    year = str_sub(Date, -4),
    county = NA,
    site_function = NA,
    fraction_of_100m = NA,
    transect_100m_standard = NA,
  ) |>
janitor::clean_names()


new_data <- new_data |>
  rename(
habitat_type_concat = habitat_list,
temp_f = temperature,
rh_percent = humidity,
collectors = collector
  )|>
  select(
    transect_no, county, site, site_function,  # First variables
    transect_type, drag_round, year, date,     # Then these
    habitat_type_concat, temp_f, rh_percent, gps_start, gps_end, start_time, end_time, collectors, everything() 
  )
```

